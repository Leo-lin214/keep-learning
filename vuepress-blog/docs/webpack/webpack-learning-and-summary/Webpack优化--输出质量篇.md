# Webpack ä¼˜åŒ–--è¾“å‡ºè´¨é‡ç¯‡

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä½¿ç”¨ Webpack æ‰“åŒ…åçš„æ–‡ä»¶å¤§å°ï¼Œä¼šç›´æ¥å½±å“åˆ°çº¿ä¸Šç”¨æˆ·çš„ä½“éªŒï¼Œå¦‚é¦–å±åŠ è½½æ—¶é—´ï¼ŒåŒ…è¶Šå¤§æ—¶ç›¸åº”çš„æ‰“å¼€æ—¶é•¿ä¹Ÿä¼šè¶Šé•¿ï¼Œæ¯•ç«Ÿè¿˜æ˜¯éœ€è¦æ—¶é—´å’Œç½‘ç»œä¸‹è½½ä¸€ä¸ªåŒ…çš„ã€‚ğŸ˜…

é‚£ä¹ˆï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å»ä½¿ç”¨ Webpack æ›´å¥½æ»´ä¼˜åŒ–æ‰“åŒ…åçš„æ–‡ä»¶å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘å°±æ¥ç®€å•è®²è§£ä¸€äº›å¸¸ç”¨æ–¹æ³•ã€‚


## ä½¿ç”¨processåŒºåˆ†ç¯å¢ƒ

åœ¨æˆ‘ä»¬å¼€å‘ web æ—¶ï¼Œä¸€èˆ¬éƒ½ä¼šåˆ†ä¸ºä¸¤ä¸ªç¯å¢ƒï¼Œåˆ†åˆ«æ˜¯å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒã€‚å¼€å‘ç¯å¢ƒå°±æ˜¯ç”¨äºå¼€å‘è€…å¼€å‘æ—¶è°ƒè¯•ä½¿ç”¨çš„ï¼Œè€Œç”Ÿäº§ç¯å¢ƒåˆ™æ˜¯é’ˆå¯¹çœŸå®ç”¨æˆ·ä½¿ç”¨çš„ã€‚

**Webpack å·²ç»å†…ç½®äº†åŒºåˆ†ç¯å¢ƒåŠŸèƒ½ï¼Œå½“ä»£ç ä¸­ä½¿ç”¨ process æ¨¡å—çš„è¯­å¥æ—¶ï¼ŒWebpack å°±ä¼šè‡ªåŠ¨æ‰“åŒ…è¿› process æ¨¡å—çš„ä»£ç ä»¥æ”¯æŒé Node.js ç¯å¢ƒ**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­è¿™æ ·åŒºåˆ†ç¯å¢ƒã€‚

```javascript
if(process.env.NODE_ENV === 'production') {
  console.log('ç”Ÿäº§ç¯å¢ƒ')
} else {
  console.log('å¼€å‘ç¯å¢ƒ')
}
```

åœ¨ Webpack 4 é‡Œï¼Œå·²ç»æ”¯æŒä½¿ç”¨ mode å±æ€§æ¥é…ç½®ç¯å¢ƒã€‚å½“ç„¶ä¹Ÿå¯ä»¥å¦‚ä¸‹é…ç½®ã€‚

```javascript
const DefinePlugin = require('webpack/lib/DefinePlugin')

module.exports = {
  plugins: [
    new DefinePlugin({
      'process.env': {
        NODE_ENV: JSON.stringify('production')
      }
    })
  ]
}
```

ä¸Šè¿°é…ç½®ä¸­ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨ JSON.stringify æ–¹æ³•å®šä¹‰ï¼Ÿç¯å¢ƒå˜é‡çš„å€¼å¿…é¡»æ˜¯ä¸€ä¸ªç”±åŒå¼•å·åŒ…è£¹çš„å­—ç¬¦ä¸²ï¼Œå³"'production'"ã€‚

å¦å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Webpack æ‰§è¡Œå‘½ä»¤ä¸Šå¸¦ä¸Šç¯å¢ƒå‚æ•°ã€‚

```javascript
webpack NODE_ENV=production
```

è¿™æ—¶å€™åœ¨ä¸Šé¢çš„ new DefinePlugin ä¸­å°±éœ€è¦è¿™æ ·å»è·å–ç¯å¢ƒå‚æ•°è¿›è¡Œå®šä¹‰ã€‚

```javascript
new DefinePlugin({
  'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV)
})
```



## åˆ©ç”¨UglifyJSå¯¹JavaScriptå‹ç¼©ï¼Œåˆ©ç”¨cssnanoå¯¹csså‹ç¼©

åœ¨æ€§èƒ½æå‡æ–¹é¢ï¼Œç›¸ä¿¡æˆ‘ä»¬éƒ½ä¼šçŸ¥é“ä½¿ç”¨ GZip å¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼Œé‚£ä¹ˆå¯¹äºæ–‡ä»¶å†…å®¹è¿›è¡Œå‹ç¼©åˆ™å¯ä»¥é€‰ç”¨ UglifyJSï¼ŒåŒæ—¶ Webpack å·²ç»å†…ç½® UglifyJSã€‚

åœ¨è¿™é‡Œï¼Œå¯ä»¥ä½¿ç”¨ ParallelUglifyJS å¼€å¯å¤šä¸ªè¿›ç¨‹å¯¹ä»£ç è¿›è¡Œå‹ç¼©æ¥åŠ å¿«æ„å»ºè¿›ç¨‹ï¼Œä½†æ˜¯ ParallelUglifyJS åº•å±‚éƒ½æ˜¯ä½¿ç”¨ UglifyJS è¿›è¡Œå·¥ä½œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰å¿…è¦äº†è§£ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ UglifyJS è¿›è¡Œä»£ç å‹ç¼©ã€‚

**ä½¿ç”¨ UglifyJS å¯¹ä»£ç è¿›è¡Œå‹ç¼©æ—¶ï¼Œé™¤äº†å¯ä»¥æå‡ç½‘é¡µåŠ è½½çš„é€Ÿåº¦ï¼Œè¿˜å¯ä»¥æ··æ·†æºç **ã€‚

UglifyJS çš„åŸºæœ¬åŸç†å°±æ˜¯ï¼Œ**åˆ†æ Javascript ä»£ç è¯­æ³•æ ‘ï¼Œç†è§£ä»£ç çš„å«ä¹‰ï¼Œä»è€Œåšåˆ°å»æ‰æ— æ•ˆä»£ç ã€å»æ‰æ—¥å¿—è¾“å‡ºä»£ç ã€ç¼©çŸ­å˜é‡åç­‰ä¼˜åŒ–**ã€‚

UglifyJS ä¸­å¸¸ç”¨çš„é€‰é¡¹å¦‚ä¸‹ï¼š

- sourceMapï¼šæ˜¯å¦ä¸ºå‹ç¼©åçš„ä»£ç ç”Ÿæˆå¯¹åº”çš„ Source Mapï¼Œé»˜è®¤ä¸ç”Ÿæˆï¼Œå¼€å¯åè€—æ—¶ä¼šå¤§å¤§å¢åŠ ã€‚
- output.beautifyï¼šæ˜¯å¦è¦ä¿ç•™ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦ï¼Œé»˜è®¤ä¸ºä¿ç•™ï¼Œä¸ºäº†è¾¾åˆ°æ›´å¥½çš„å‹ç¼©æ•ˆæœï¼Œå¯è®¾ç½® falseã€‚
- output.commentsï¼šæ˜¯å¦ä¿ç•™ä»£ç ä¸­çš„æ³¨é‡Šï¼Œé»˜è®¤ä¿ç•™ï¼Œå¯è®¾ç½®ä¸º falseã€‚
- compress.warningï¼šæ˜¯å¦åˆ é™¤æ²¡æœ‰ç”¨åˆ°çš„è¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼Œé»˜è®¤ä¸ºè¾“å‡ºï¼Œå¯è®¾ç½®ä¸º falseã€‚
- compress.drop_consoleï¼šæ˜¯å¦åˆ é™¤ä»£ç ä¸­æ‰€æœ‰çš„consoleè¯­å¥ã€‚
- compress.collapse_varsï¼šæ˜¯å¦å†…åµŒè™½ç„¶å·²å®šä¹‰ä½†æ˜¯åªç”¨åˆ°ä¸€æ¬¡çš„å˜é‡ï¼Œå¦‚ var x = 5; y = x; è½¬æ¢æˆ y = 5ï¼Œé»˜è®¤ä¸ºä¸è½¬æ¢ï¼Œå¯è®¾ç½®ä¸º trueã€‚
- compress.reduce_varsï¼šæ˜¯å¦æå–å‡ºç°å¤šæ¬¡ä½†æ˜¯æ²¡å®šä¹‰æˆå˜é‡å»å¼•ç”¨çš„é™æ€å€¼ã€‚å¦‚ x = 1; y = 1; è½¬æ¢æˆ var a = 1; x = a; y = aï¼Œé»˜è®¤ä¸è½¬æ¢ï¼Œå¯ä»¥è®¾ç½®ä¸º trueã€‚

å¯¹äºä½¿ç”¨ UglifyJs è¿›è¡Œé…ç½®å¦‚ä¸‹ï¼š

```javascript
const UglifyJsPlugin = require('webpack/lib/optimize/UglifyJsPlugin')

module.exports = {
  plugins: [
    new UglifyJsPlugin({
      compress: {
        warnings: false,
        drop_console: true,
        collapse_vars: true,
        reduce_vars: true
      },
      output: {
        beautify: false,
        comments: false
      }
    })
  ]
}
```

Webpack å†…ç½®çš„ UglifyJsPlugin ç”¨çš„æ˜¯ UglifyJS2ã€‚**å½“æ‰§è¡Œ webpack --optimize-minimize å‘½ä»¤æ—¶ï¼Œä¼šè‡ªåŠ¨æ³¨å…¥ UglifyJSPlugin**ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**UglifyJS åªç†è§£ ES5 è¯­æ³•çš„ä»£ç ï¼Œå› æ­¤ä¸€èˆ¬æ˜¯éœ€è¦ç»“åˆ Babel ä¸€èµ·ä½¿ç”¨ã€‚è‹¥åªæ˜¯å•çº¯å‹ç¼© ES6 ä»£ç ï¼Œåˆ™éœ€è¦ç”¨åˆ° UglifyES**ã€‚

å¦‚æœéœ€è¦åœ¨ Webpack æ¥å…¥ UglifyESï¼Œåˆ™éœ€è¦å•ç‹¬å®‰è£…æœ€æ–°ç‰ˆçš„ uglifyjs-webpack-pluginã€‚

```javascript
npm i -D uglifyjs-webpack-plugin@beta

// é…ç½®å¦‚ä¸‹
const UglifyEsPlugin = reqire('uglifyjs-webpack-plugin')

module.exports = {
  plugins: [
    new UglifyEsPlugin({
      compress: {
        warnings: false,
        drop_console: true,
        collapse_vars: true,
        reduce_vars: true
      },
      output: {
        beautify: false,
        comments: false
      }
    })
  ]
}
```

**åœ¨æ¥å…¥ UglifyES æ—¶ï¼Œéœ€è¦ babel-loader ä¸èƒ½è½¬æ¢ ES5 ä»£ç ï¼Œå³éœ€è¦åœ¨ .babelrc ä¸­å»æ‰ babel-preset-env**ã€‚

æ—¢ç„¶ JavaScript ä»£ç å¯ä»¥å‹ç¼©ï¼Œé‚£ä¹ˆ css ä»£ç èƒ½å¦ä¹Ÿå‹ç¼©ä¸€ä¸‹ï¼Ÿ

**å¦‚æœå‹ç¼© css ä»£ç ï¼Œéœ€è¦ç”¨åˆ°çš„å‹ç¼©å·¥å…·åˆ™æ˜¯ cssnanoï¼ŒåŸºäº PostCSS å®ç°çš„**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ css ä¸­ï¼Œmargin: 10px 20px 10px 20px; ä¼šè¢«è½¬æ¢æˆ margin: 10px 20px; ã€color: #000 è½¬æ¢æˆ color: black;ã€‚

é‚£ä¹ˆåœ¨ Webpack ä¸­æ€ä¹ˆæ¥å…¥ cssnano å‘¢ï¼Ÿ

å…¶å®**åœ¨ css-loader ä¸­å·²ç»å†…ç½®äº† cssnanoï¼Œè‹¥éœ€å¼€å¯ï¼Œåˆ™åªéœ€è¦åŠ ä¸Š minimize é€‰é¡¹å³å¯**ã€‚

```javascript
module.exports = {
  module: {
    rule: [
      {
        test: /\.css$/,
        use: ExtractTextPlugin.extract({
          use: ['css-loader?minimize']
        })
      }
    ]
  }
}
```



## é…ç½®publicPathæŒ‡å‘CDNæœåŠ¡åŠ é€Ÿ

ç›¸ä¿¡å¤§å®¶å¯¹ CDN å¹¶ä¸é™Œç”Ÿï¼Œ**CDN å¯ä»¥åŠ é€Ÿç½‘ç»œä¼ è¾“ï¼Œé€šè¿‡å°†èµ„æºéƒ¨ç½²åˆ°ä¸–ç•Œå„åœ°ï¼Œä½¿ç”¨æˆ·åœ¨è®¿é—®æ—¶æŒ‰ç…§å°±è¿‘åŸåˆ™ä»ç¦»æœ€è¿‘çš„æœåŠ¡å™¨ä¸Šè·å–èµ„æºï¼Œä»è€ŒåŠ å¿«èµ„æºçš„è·å–**ã€‚

åœ¨é¡¹ç›®ä¸­å¸¸ç”¨çš„ CDN æ–¹å¼æ˜¯å¦‚ä¸‹ï¼š

- **å¯¹äºé¡¹ç›®ä¸­ HTML æ–‡ä»¶ï¼Œç›´æ¥æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å‚¨å­˜ï¼Œè€Œä¸æ˜¯æ”¾åˆ° CDN æœåŠ¡ä¸Š**ï¼ŒåŒæ—¶éœ€è¦å…³é—­é¡¹ç›®æœåŠ¡å™¨çš„ç¼“å­˜ï¼Œé¡¹ç›®æœåŠ¡å™¨åªæä¾› HTML æ–‡ä»¶å’Œæ•°æ®æ¥å£ã€‚
- **é’ˆå¯¹æ‰“åŒ…å¥½çš„ JavaScriptã€CSSã€å›¾ç‰‡ç­‰é™æ€æ–‡ä»¶ï¼Œéƒ½æ”¾åœ¨ CDN æœåŠ¡ä¸Šï¼Œå¹¶å¼€å¯ CDN ç¼“å­˜**ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªæ–‡ä»¶å¸¦ä¸Šä¸€ä¸ª hash å€¼ï¼Œå¦‚ a.asvf1231sd.js æ–‡ä»¶ã€‚å¸¦ä¸Š hash åŸå› æ˜¯ï¼Œå½“å‘ç‰ˆæ–°çš„ä»£ç åˆ°ç”Ÿäº§ä¸Šï¼Œé¿å…ç”¨æˆ·ä¾æ—§ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆä»£ç ï¼Œæ¯æ¬¡å‘ç‰ˆéƒ½ä¼šæ›´æ–°ç›¸åº”çš„ hash å€¼å‘Šè¯‰æµè§ˆå™¨æ‹‰å–æœ€æ–°çš„ä»£ç ã€‚

ç”±äºæµè§ˆå™¨æœ‰ä¸€ä¸ªè§„åˆ™æ˜¯ï¼Œ**åœ¨åŒä¸€æ—¶åˆ»é’ˆå¯¹åŒä¸€ä¸ªåŸŸåçš„èµ„æºçš„å¹¶è¡Œè¯·æ±‚æœ‰é™åˆ¶ï¼Œä¸€èˆ¬ä¸º 4 ä¸ªå·¦å³ï¼Œä¸åŒçš„æµè§ˆå™¨å¯èƒ½ä¸åŒ**ã€‚**ä¸ºäº†é¿å…å°†æ‰€æœ‰çš„ JavaScriptã€CSSã€å›¾ç‰‡ç­‰é™æ€æ–‡ä»¶åªæ”¾åœ¨ä¸€ä¸ªæœåŠ¡ä¸Šï¼Œå¯ä»¥å°è¯•å°†è¿™äº›é™æ€èµ„æºåˆ†æ•£åˆ°ä¸åŒçš„ CDN æœåŠ¡ä¸Š**ã€‚ï¼ˆå³ JavaScript æ–‡ä»¶æ”¾åˆ°å•ç‹¬çš„ js CDN æœåŠ¡ä¸Šï¼ŒCSS æ–‡ä»¶æ”¾åˆ°å•ç‹¬çš„ css CDN æœåŠ¡ä¸Šï¼‰

æ—¢ç„¶å¦‚æ­¤ï¼ŒWebpack åº”è¯¥å¦‚ä½•æ¥å…¥ CDN å‘¢ï¼Ÿè¦æ¥å…¥ CDN æœåŠ¡ï¼Œéœ€è¦å®ç°ä»¥ä¸‹å‡ ç‚¹ã€‚

- ä½¿ç”¨ publicPath æŒ‡å‘ CDN æœåŠ¡çš„ç»å¯¹è·¯å¾„åœ°å€ï¼Œè€Œä¸æ˜¯æŒ‡å‘é¡¹ç›®çš„æœåŠ¡åœ°å€ä¸Šã€‚
- é™æ€èµ„æºçš„æ–‡ä»¶åéœ€è¦å¸¦ä¸Šç›¸åº”çš„ hash å€¼ï¼Œé¿å…è¢«ç¼“å­˜ã€‚
- å°†ä¸åŒç±»ä¼¼çš„èµ„æºæ”¾åˆ°ä¸åŒçš„ CDN æœåŠ¡ä¸Šï¼Œé¿å…èµ„æºçš„å¹¶è¡Œä¸‹è½½é™åˆ¶ã€‚

ç›´æ¥çœ‹çœ‹åœ¨ Webpack ä¸­å¦‚ä½•é…ç½®çš„ã€‚

```javascript
const path = require('path')
const ExtractTextPlugin = require('extract-text-webpack-plugin')
const {WebPlugin} = require('web-webpack-plugin')

module.exports = {
  output: {
    filename: '[name]_[chunkhash:8].js',
    path: path.resolve(__dirname, './dist'),
    // æŒ‡å®šå­˜æ”¾JavaScriptæ–‡ä»¶çš„CDNæœåŠ¡åœ°å€
    publicPath: '//js.cdn.com/id'
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: ExtractTextPlugin.extract({
          use: ['css-loader?minimize'],
          // æŒ‡å®šå­˜æ”¾CSSä¸­å¯¼å…¥çš„èµ„æºï¼ˆå¦‚å›¾ç‰‡ï¼‰çš„CDNæœåŠ¡åœ°å€
          publicPath: '//img.cdn.com/id'
        })
      },
      {
        test: /\.png$/,
        // ä¸ºè¾“å…¥çš„PNGæ–‡ä»¶åŠ ä¸ŠHashå€¼ï¼Œå¹¶æŒ‡å®šhashçš„é•¿åº¦ä¸º8ä½
        use: ['file-loader?name=[name]_[hash:8].text']
      }
    ]
  },
  plugins: [
    new WebPlugin({
      // HTMLæ¨¡æ¿æ‰€åœ¨ä½ç½®
      template: './template.html',
      // è¾“å‡ºçš„HTMLæ–‡ä»¶å
      filename: 'index.html',
      // æŒ‡å®šå­˜æ”¾cssæ–‡ä»¶çš„CDNæœåŠ¡åœ°å€
      stylePublic: '//css.cdn.com/id/'
    }),
    new ExtractTextPlugin({
      // ä¸ºè¾“å‡ºçš„CSSæ–‡ä»¶ååŠ ä¸Šhashå€¼ï¼Œå¹¶æŒ‡å®šhashçš„é•¿åº¦ä¸º8ä½
      filename: '[name]_[contentHash:8]'
    })
  ]
}
```



## ä½¿ç”¨Tree-Shakingå»é™¤å¤šä½™çš„æ— ç”¨ä»£ç 

**Tree Shaking å¯ç”¨äºå‰”é™¤ JavaScript ä¸­ç”¨ä¸ä¸Šçš„æ­»ä»£ç ï¼Œæ˜¯åŸºäºé™æ€çš„ ES6 æ¨¡å—åŒ–è¯­æ³•çš„**ï¼ˆå³ä¾èµ–äº import å’Œ exportï¼‰ã€‚

ç®€å•æ»´æ¥è¯´ï¼ŒTree Shaking ä¸æ”¯æŒå…¶ä»–æ¨¡å—åŒ–å¦‚ RequireJSã€CommonJS ç­‰ã€‚

æ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹ï¼Œæ˜¯å¦‚ä½•é…ç½® Tree Shaking çš„ã€‚ğŸ¤”

é¦–å…ˆï¼Œéœ€è¦åœ¨ babel çš„é…ç½®ä¸‹ï¼Œç¦æ­¢ ES6 æ¨¡å—åŒ–è½¬æ¢æˆ ES5 çš„å½¢å¼ï¼Œå› æ­¤åœ¨ .babelrc æ–‡ä»¶ä¸­é…ç½®å¦‚ä¸‹ï¼š

```javascript
{
  "presets": [
    "env",
    {
      "modules": false
    }
  ]
}
```

ä¸Šè¿°çš„ **modules: false çš„å«ä¹‰å°±æ˜¯å…³é—­ babel çš„æ¨¡å—è½¬æ¢åŠŸèƒ½ï¼Œä¿ç•™åŸæœ¬çš„ ES6 æ¨¡å—åŒ–è¯­æ³•**ã€‚

ä» Webpack 2.0 å¼€å§‹ï¼ŒWebpack è‡ªå¸¦ Tree Shaking åŠŸèƒ½ã€‚å¦å¤–ï¼Œåœ¨æ‰§è¡Œ webpack å‘½ä»¤æ—¶å¸¦ä¸Š --display-used-exports å‚æ•°ï¼Œå¯è¿½è¸ª Tree Shaking çš„å·¥ä½œã€‚

**Webpack åªæ˜¯æŒ‡å‡ºå“ªäº›å‡½æ•°è¢«ç”¨ä¸Šï¼Œè€Œå“ªäº›å‡½æ•°æ²¡è¢«ç”¨ä¸Šï¼Œä»¥åŠè…°å‰”é™¤ç”¨ä¸ä¸Šçš„ä»£ç ï¼Œåˆ™è¿˜è¦ç»è¿‡ UglifyJS å¤„ç†ä¸€ç•ªã€‚**

åœ¨ä½¿ç”¨å¤§é‡çš„ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œä¼šå‘ç° Tree Shaking ä¼¼ä¹å¹¶ä¸ç”Ÿæ•ˆï¼ŒåŸå› æ˜¯å¤§éƒ¨åˆ† NPM åŒ…ä¸­çš„ä»£ç éƒ½é‡‡ç”¨äº† CommonJS æ¨¡å—åŒ–è¯­æ³•ã€‚å½“ç„¶æœ‰äº›åº“å·²ç»è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œåœ¨å‘å¸ƒåˆ° NPM ä¸Šæ—¶ä¼šåŒæ—¶æä¾›ä¸¤ä»½ä»£ç ï¼Œä¸€ä»½ç”¨äº CommonJS æ¨¡å—åŒ–è¯­æ³•ï¼Œä¸€ä»½é‡‡ç”¨ ES6 æ¨¡å—åŒ–è¯­æ³•ï¼Œå¹¶ä¸”åœ¨ package.json æ–‡ä»¶ä¸­ä¼šåˆ†åˆ«æŒ‡å‡ºè¿™ä¸¤ä»½ä»£ç çš„å…¥å£ã€‚

ä»¥ Redux ä¸ºä¾‹ï¼Œåœ¨å…¶ package.json ä¸­ä¼šè¿™æ ·æŒ‡æ˜å…¥å£ï¼š

```javascript
{
  // ...
  "main": "lib/index.js", // æŒ‡æ˜é‡‡ç”¨CommonJSæ¨¡å—åŒ–çš„ä»£ç å…¥å£
	"jsnext:main": "es/index.js" // æŒ‡æ˜é‡‡ç”¨ES6æ¨¡å—åŒ–çš„ä»£ç å…¥å£
  // ...
}
```

åœ¨å‰é¢å·²ç»æåˆ°è¿‡ï¼Œresolve.mainFields ç”¨äºé…ç½®é‡‡ç”¨å“ªä¸ªå­—æ®µä½œä¸ºæ¨¡å—çš„å…¥å£æè¿°ï¼Œå› æ­¤ï¼Œä¸ºäº†è®© Tree Shaking å¯¹ä¸Šé¢çš„ Redux æœ‰æ•ˆï¼Œéœ€è¦é…ç½®å¦‚ä¸‹ï¼š

```javascript
module.exports = {
  resolve: {
    // é’ˆå¯¹NPMä¸­çš„ç¬¬ä¸‰æ–¹æ¨¡å—ä¼˜å…ˆé‡‡ç”¨jsnext:mainä¸­æŒ‡å‘ES6æ¨¡å—åŒ–è¯­æ³•çš„æ–‡ä»¶
    mainFields: ['jsnext:main', 'browser', 'main']
  }
}
```

é‡‡ç”¨ jsnext:main ä½œä¸º ES6 æ¨¡å—åŒ–ä»£ç çš„å…¥å£æ˜¯ç¤¾åŒºçš„ä¸€ä¸ªçº¦å®šã€‚



## æå–å…¬å…±ä»£ç å’Œç¬¬ä¸‰æ–¹ä»£ç 

å½“æ¯ä¸ªé¡µé¢çš„ä»£ç éƒ½å°†å…¬å…±çš„ä»£ç åŒ…å«è¿›å»ï¼Œå°±ä¼šé€ æˆï¼š

- ç›¸åŒçš„èµ„æºè¢«é‡å¤åŠ è½½ï¼Œæµªè´¹ç”¨æˆ·çš„æµé‡å’ŒæœåŠ¡å™¨çš„æˆæœ¬ï¼›
- æ¯ä¸ªé¡µé¢éœ€è¦åŠ è½½çš„èµ„æºå¤ªå¤§ï¼Œå¯¼è‡´ç½‘é¡µé¦–å±åŠ è½½ç¼“æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒï¼›

éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œ**åœ¨ Webpack 3.0 ä¸­ä½¿ç”¨æ’ä»¶ CommonChunkPlugin æå–å…¬å…±éƒ¨åˆ†ï¼Œåœ¨ Webpack 4.0 ååˆ™éœ€è¦åœ¨ optimization.splitChunk ä¸­è¿›è¡Œé…ç½®æå–å…¬å…±éƒ¨åˆ†**ã€‚åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°ï¼Œè™½ç„¶ CommonChunkPlugin å¯ç”¨æ¥é¿å…ä½¿ç”¨é‡å¤çš„ä¾èµ–ï¼Œä½†è‹¥æƒ³è¿›ä¸€æ­¥çš„ä¼˜åŒ–æ˜¯ä¸å¯èƒ½çš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œä¼šæŒ‰ç…§ä»¥ä¸‹è§„åˆ™è¿›è¡Œæå–å…¬å…±ä»£ç ã€‚

- å°†é¡¹ç›®ä¸­æ‰€ç”¨åˆ°çš„**ç¬¬ä¸‰æ–¹ä»£ç ç»Ÿä¸€æ‰“åŒ…**åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ˆå¦‚vendors.jsï¼‰ã€‚
- åœ¨å‰”é™¤ç¬¬ä¸‰æ–¹ä»£ç åï¼Œå†æ‰¾å‡º**æ‰€æœ‰é¡µé¢éƒ½ä¾èµ–çš„å…¬å…±éƒ¨åˆ†ä»£ç **ï¼Œå°†å®ƒä»¬æå–å‡ºæ¥å¹¶æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ˆå¦‚commons.jsï¼‰ã€‚
- æœ€åå†ä¸ºæ¯ä¸ªé¡µé¢éƒ½ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä¸å†åŒ…å«ç¬¬ä¸‰æ–¹ä»£ç ä»¥åŠå…¬å…±éƒ¨åˆ†ä»£ç ã€‚

ä¹Ÿè®¸ä½ ä¼šè§‰å¾—å¾ˆå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆä¸å¯ä»¥å°†ç¬¬ä¸‰æ–¹ä»£ç éƒ½æ”¾åˆ°å…¬å…±éƒ¨åˆ†ä»£ç ä¸­å»ï¼Ÿ

å…¶å®å°±æ˜¯ä¸ºäº†**é•¿æœŸç¼“å­˜ç¬¬ä¸‰æ–¹ä»£ç **ã€‚ç”±äºç¬¬ä¸‰æ–¹ä»£ç æ˜¯åŸºæœ¬ä¸ä¼šæ›´æ–°ï¼Œç›¸åé¡µé¢ä¾èµ–çš„å…¬å…±éƒ¨åˆ†ä»£ç åˆ™ä¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚çš„ä¸åŒè€Œå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤éœ€åŒºåˆ«å¯¹å¾…ã€‚

ç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼Œåœ¨ Webpack 4.0 ä¸­æ˜¯å¦‚ä½•è¿›è¡Œæå–ç¬¬ä¸‰æ–¹ä»£ç å’Œé¡µé¢ä¾èµ–çš„å…¬å…±éƒ¨åˆ†ä»£ç çš„ã€‚

```javascript
module.exports = {
  // ...
  optimization: {
    splitChunks: {
      chunks: 'initial', // è¡¨ç¤ºåŒæ­¥æ¨¡å—ï¼Œæœ‰ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯initial(åˆå§‹åŒ–ï¼Œæ‰“åŒ…ç¬¬ä¸‰æ–¹ä»£ç ç”¨åˆ°)ã€all(æ‰€æœ‰å—)ã€async(å¼‚æ­¥å—ï¼ŒæŒ‰éœ€åŠ è½½ç”¨åˆ°) 
      minSize: 30000,  // å—çš„æœ€å°å€¼
      maxSize: 0, // å—çš„æœ€å¤§å€¼
      minChunks: 1, // æ‹†åˆ†å‰å¿…é¡»å…±äº«æ¨¡å—çš„æœ€å°å—æ•°
      maxAsyncRequests: 5, // æŒ‰éœ€åŠ è½½æ—¶æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°
      maxInitialRequests: 3, // å…¥å£ç‚¹çš„æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°
      automaticNameDelimiter: '~', // é»˜è®¤æƒ…å†µä¸‹ï¼Œwebpackå°†ä½¿ç”¨å—çš„æ¥æºå’Œåç§°ç”Ÿæˆåç§°ï¼ˆå¦‚vendorsï½main.jsï¼‰
      name: true, // æ‹†åˆ†å—çš„åç§°ï¼Œæä¾›trueå°†åŸºäºå—å’Œç¼“å­˜ç»„å¯†é’¥è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåç§°
      cacheGroups: { // ç¼“å­˜æ¨¡å—
        vendors: { // åŸºæœ¬æ¡†æ¶
          chunks: 'all',
          test: /(react|react-dom|react-dom-router|babel-polyfill|mobx)/,
          priority: 100,
          name: 'vendors',
        },
        d3Venodr: { // å°†ä½“ç§¯è¾ƒå¤§çš„d3å•ç‹¬æå–åŒ…ï¼ŒæŒ‡å®šé¡µé¢éœ€è¦çš„æ—¶å€™å†å¼‚æ­¥åŠ è½½
          test: /d3/,
          priority: 100, // è®¾ç½®é«˜äºasync-commonsï¼Œé¿å…æ‰“åŒ…åˆ°async-commonä¸­
          name: 'd3Venodr',
          chunks: 'async'
        },
        echartsVenodr: { // å¼‚æ­¥åŠ è½½echartsåŒ…
          test: /(echarts|zrender)/,
          priority: 100, // é«˜äºasync-commonsä¼˜å…ˆçº§
          name: 'echartsVenodr',
          chunks: 'async'
        },
        'async-commons': { // å…¶ä½™å¼‚æ­¥ç»„ä»¶åŠ è½½åŒ…
          chunks: 'async',
          minChunks: 2,
          name: 'async-commons',
          priority: 90,
        },
        commons: { // å…¶ä½™åŒæ­¥åŠ è½½åŒ…
          chunks: 'all',
          minChunks: 2,
          name: 'commons',
          priority: 80,
        }
      }
    }
  }
}
```

å¯¹äº splitChunks ä¸­çš„ chunksï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼š

- allï¼šä¸ç®¡æ–‡ä»¶æ˜¯åŠ¨æ€è¿˜æ˜¯éåŠ¨æ€è½½å…¥ï¼Œç»Ÿä¸€å°†æ–‡ä»¶åˆ†ç¦»ã€‚å½“é¡µé¢é¦–æ¬¡è½½å…¥ä¼šå¼•å…¥æ‰€æœ‰çš„åŒ…ã€‚
- initalï¼šå°†å¼‚æ­¥å’Œéå¼‚æ­¥çš„æ–‡ä»¶åˆ†ç¦»ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶è¢«å¼‚æ­¥å¼•å…¥ä¹Ÿè¢«éå¼‚æ­¥å¼•å…¥ï¼Œé‚£å®ƒä¼šè¢«æ‰“åŒ…ä¸¤æ¬¡ï¼ˆæ³¨æ„å’ŒallåŒºåˆ«ï¼‰ï¼Œç”¨äºåˆ†ç¦»é¡µé¢é¦–æ¬¡éœ€è¦åŠ è½½çš„åŒ…ã€‚ï¼ˆ**ç¬¬ä¸‰æ–¹ä»£ç å¼•å…¥**ï¼‰ã€‚
- asyncï¼šå°†å¼‚æ­¥åŠ è½½çš„æ–‡ä»¶åˆ†ç¦»ï¼Œé¦–æ¬¡ä¸€èˆ¬ä¸å¼•å…¥ï¼Œåˆ°éœ€è¦å¼‚æ­¥å¼•å…¥çš„ç»„ä»¶æ‰ä¼šå¼•å…¥ï¼ˆå³**æŒ‰éœ€å¼•å…¥**ï¼‰ã€‚



## æå–æ‡’åŠ è½½ä»£ç ï¼ˆå³æŒ‰éœ€åŠ è½½çš„ä»£ç ï¼‰

åœ¨ä¸Šé¢ä½¿ç”¨ splitChunkPlugin æå–ä»£ç ä¸­ï¼Œå…¶å®å·²ç»æœ‰æåŠåˆ°å¯¹æ‡’åŠ è½½ä»£ç çš„æå–ï¼Œå°±æ˜¯ chunk å€¼ä¸º async ã€‚

ç›¸ä¿¡ç”¨è¿‡ Reactã€Vue çš„ç«¥é‹ä»¬ï¼Œè‚¯å®šå¯¹ import() æ–¹æ³•ä¸é™Œç”Ÿï¼Œå®ƒå°±æ˜¯ç”¨æ¥å®ç°ç»„ä»¶çš„æ‡’åŠ è½½çš„ã€‚

**import() è¿”å›ä¸€ä¸ª Promiseï¼Œä¾èµ–äº Promise**ã€‚ä¸‹é¢å°±ä½¿ç”¨ React-Router å®ç°ç»„ä»¶æ‡’åŠ è½½æ —å­ã€‚

```javascript
import React, {PureComponent, createElement} from 'react'
import ReactDom from 'react-dom'

function getAsyncComponent(load) {
  return class AsyncComponent extends PureComponent {
    componentDidMount() {
      load().then({ default: component } => {
        this.setState({
          component
        })
      })
    }
    render() {
      const {component} = this.state
      return component ? createElement(component) : null
    }
  }
}

function App() {
  return (
  	<HashRouter>
    	<div>
    		<nav><link to="/about">About</link></nav>
    	</div>
      <Route path="/about" component={getAsyncComponent(() => import(/* webpackChunkName: about */ './pages/about'))}></Route>
    </HashRouter>
  )
}
```

ä»¥ä¸Šä»£ç éœ€è¦åœ¨ Webpack ä¸­é…ç½®å¥½ç›¸åº”çš„ babel-loaderï¼Œå°†æºç å…ˆæäº¤ç»™ babel-loader å¤„ç†ï¼Œå†æäº¤ç»™ Webpack å¤„ç†å…¶ä¸­çš„ import(\*) è¯­å¥ã€‚ä½†æ˜¯ç”±äº babel-loader å¹¶ä¸è®¤è¯† import(\*) è¯­å¥ï¼Œå› æ­¤ä¼šæŠ¥é”™ã€‚

ä¸ºäº†è®© babel-loader å¤„ç† import(\*) è¯­å¥ï¼Œéœ€è¦å®‰è£…ä¸€ä¸ª babel æ’ä»¶ babel-plugin-syntax-dynamic-importã€‚éœ€åœ¨ .babelrc æ–‡ä»¶åšå¦‚ä¸‹é…ç½®ã€‚

```javascript
{
  "presets": [
    "env", "react"
  ],
  "plugins": [
    "syntax-dynamic-import"
  ]
}
```



## å¼€å¯Scope Hoisting

Scope Hoisting å¯ä»¥è®© Webpack æ‰“åŒ…å‡ºæ¥çš„ä»£ç æ–‡ä»¶æ›´å°ã€è¿è¡Œæ›´å¿«ï¼Œåˆç§°ä¸ºä½œç”¨åŸŸæå‡ã€‚

**Scope Hoisting å®ç°çš„åŸºæœ¬åŸç†æ˜¯ï¼Œåˆ†ææ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå°½å¯èƒ½å°†è¢«æ‰“æ•£çš„æ¨¡å—åˆå¹¶åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä½†å‰ææ˜¯ä¸èƒ½é€ æˆä»£ç å†—ä½™**ã€‚

é‚£ä¹ˆè¦å¼€å¯ Scope Hoistingï¼Œåœ¨ Webpack ä¸­å¦‚ä½•é…ç½®å‘¢ï¼Ÿ**åªéœ€è¦ç”¨åˆ°å†…ç½®çš„ ModuleConcatenationPlugin æ’ä»¶å³å¯å¼€å¯ Scope Hoisting**ã€‚

```javascript
const ModuleConcatenationPlugin = require('webpack/lib/optimize/ModuleConcatenationPlugin')

module.exports = {
  plugins: [
    new ModuleConcatenationPlugin()
  ]
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒScope Hoisting ä¾èµ–æºç æ—¶éœ€é‡‡ç”¨ ES6 æ¨¡å—åŒ–ä»£ç ï¼Œè¿˜éœ€é…ç½® resolve.mainFieldsã€‚å› ä¸ºå¤§éƒ¨åˆ† NPM åŒ…çš„ç¬¬ä¸‰æ–¹åº“éƒ½æ˜¯é‡‡ç”¨ CommomJS è¯­æ³•ï¼Œå› æ­¤éœ€é…ç½® resolve.mainFields æŒ‡å‘ä½¿ç”¨ ES6 æ¨¡å—åŒ–ä»£ç ã€‚

```javascript
module.exports = {
  resolve: {
    mainFields: ['jsnext:main', 'browser', 'main']
  }
}
```

å½“ç„¶ï¼Œå¯¹äºé‡‡ç”¨äº†é ES6 æ¨¡å—åŒ–çš„ä»£ç ï¼ŒWebpack åˆ™ä¼šé™çº§å¤„ç†ä¸”ä¸ä½¿ç”¨ Scope Hoisting è¿›è¡Œä¼˜åŒ–ã€‚









































